<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JorgeBot - Painel Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>    
  <nav id="navbar">
        <a href="index.html">Voltar ao Chat</a>
        <a href="historico.html">Hist√≥rico de Conversas</a>
        <a href="sobrebot.html">Sobre o Criador</a>
    </nav>

    <!-- Tela de Login -->
    <div id="login-screen" class="login-container">
        <h1>üîê Acesso Administrativo</h1>
        
        <div class="password-info">
            <strong>üí° SENHA CONFIGURADA ATUALMENTE:</strong><br>
            A senha √© definida na vari√°vel <code>ADMIN_PASSWORD</code> no servidor.
        </div>
        
        <p style="margin: 20px 0; opacity: 0.8;">Digite a senha de administrador para acessar o painel</p>
        <input type="password" id="admin-password" class="input-field" placeholder="Senha de administrador" autocomplete="current-password">
        <button id="login-btn" class="btn" style="width: 100%;">Entrar</button>
        <div id="login-error" class="status-message status-error hidden">
            Senha incorreta. Tente novamente.
        </div>
    </div>

    <!-- Painel de Administra√ß√£o -->
    <div id="admin-panel" class="admin-container hidden">
        <div class="admin-header">
            <h1>üõ†Ô∏è Painel de Administra√ß√£o - JorgeBot</h1>
            <button id="logout-btn" class="logout-btn">Sair</button>
        </div>

        <div class="admin-content">
            <!-- Se√ß√£o de M√©tricas -->
            <div class="metrics-section">
                <h2>üìä Estat√≠sticas do Sistema</h2>
                
                <div class="metric-card">
                    <h3>Total de Conversas</h3>
                    <div id="total-conversations" class="metric-value">--</div>
                </div>

                <div class="metric-card">
                    <h3>Total de Mensagens</h3>
                    <div id="total-messages" class="metric-value">--</div>
                </div>
                <div class="metric-card">
                    <h3>Dura√ß√£o M√©dia da Conversa</h3>
                    <div id="average-duration" class="metric-value">--</div>
                </div>

                <div class="metric-card">
                    <h3>Total de Erros</h3>
                    <div id="total-errors" class="metric-value">--</div>
                </div>

                <!-- NOVAS M√âTRICAS DE ENGAJAMENTO -->
                <div class="metric-card">
                    <h3>Profundidade M√©dia</h3>
                    <div id="engagement-depth" class="metric-value">--</div>
                    <small>M√©dia de mensagens por conversa</small>
                </div>

                <div class="metric-card">
                    <h3>Conversas Curtas (‚â§3)</h3>
                    <div id="short-conversations" class="metric-value">--</div>
                </div>

                <div class="metric-card">
                    <h3>Conversas Longas (>3)</h3>
                    <div id="long-conversations" class="metric-value">--</div>
                </div>

                <div class="conversations-list">
                    <h3>√öltimas 5 Conversas</h3>
                    <div id="recent-conversations">
                        <div class="conversation-item">Carregando...</div>
                    </div>
                </div>

                <button id="refresh-stats-btn" class="btn btn-secondary" style="width: 100%;">
                    üîÑ Atualizar Estat√≠sticas
                </button>
            </div>

            <!-- Se√ß√£o de Controle -->
            <div class="control-section">
                <h2>ü§ñ Controle da IA</h2>
                
                <div class="system-instruction-area">
                    <h3>Personalidade do Bot (System Instruction)</h3>
                    <textarea 
                        id="system-instruction-textarea" 
                        placeholder="Cole aqui a nova instru√ß√£o de sistema para definir a personalidade do bot...">
                    </textarea>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="save-instruction-btn" class="btn">üíæ Salvar Nova Instru√ß√£o</button>
                        <button id="load-instruction-btn" class="btn btn-secondary">üì• Carregar Atual</button>
                    </div>

                    <div id="instruction-status" class="hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Configura√ß√µes da API
    const API_BASE_URL = 'https://chatbot-liau.onrender.com';
    
    // Elementos do DOM
    const loginScreen = document.getElementById('login-screen');
    const adminPanel = document.getElementById('admin-panel');
    const adminPassword = document.getElementById('admin-password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');
    
    // Elementos das m√©tricas
    const totalConversations = document.getElementById('total-conversations');
    const totalMessages = document.getElementById('total-messages');
    const totalErrors = document.getElementById('total-errors');
    const averageDuration = document.getElementById('average-duration');
    const engagementDepth = document.getElementById('engagement-depth');
    const shortConversations = document.getElementById('short-conversations');
    const longConversations = document.getElementById('long-conversations');
    const recentConversations = document.getElementById('recent-conversations');
    const refreshStatsBtn = document.getElementById('refresh-stats-btn');
    
    // Elementos do controle da IA
    const systemInstructionTextarea = document.getElementById('system-instruction-textarea');
    const saveInstructionBtn = document.getElementById('save-instruction-btn');
    const loadInstructionBtn = document.getElementById('load-instruction-btn');
    const instructionStatus = document.getElementById('instruction-status');

    let authToken = '';
    
    function showStatus(element, message, isError = false) {
        element.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
        element.textContent = message;
        element.classList.remove('hidden');
        setTimeout(() => element.classList.add('hidden'), 4000);
    }
    
    async function handleLogin() {
        const password = adminPassword.value.trim();
        if (!password) {
            showStatus(loginError, 'Por favor, digite a senha.', true);
            return;
        }

        loginBtn.disabled = true;
        loginBtn.textContent = 'Verificando...';

        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/stats`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${password}` }
            });

            if (response.ok) {
                authToken = password;
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                await loadStatistics();
                await loadCurrentInstruction();
            } else {
                showStatus(loginError, 'Senha incorreta. Tente novamente.', true);
            }
        } catch (error) {
            console.error('Erro no login:', error);
            showStatus(loginError, 'Erro de conex√£o. Tente novamente.', true);
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'Entrar';
        }
    }

    async function loadStatistics() {
        refreshStatsBtn.disabled = true;
        refreshStatsBtn.textContent = 'üîÑ Carregando...';

        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/stats`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (!response.ok) throw new Error('Falha ao carregar estat√≠sticas');

            const stats = await response.json();
            
            // Preenche todos os cards com os novos dados
            totalConversations.textContent = stats.totalConversations || 0;
            totalMessages.textContent = stats.totalMessages || 0;
            totalErrors.textContent = stats.totalErrors || 0;
            averageDuration.textContent = `${stats.averageConversationDuration || 0}s`;
            engagementDepth.textContent = stats.engagementDepth || 0;
            shortConversations.textContent = stats.shortConversations || 0;
            longConversations.textContent = stats.longConversations || 0;
            
            if (stats.recentConversations && stats.recentConversations.length > 0) {
                recentConversations.innerHTML = stats.recentConversations
                    .map(conv => `
                        <div class="conversation-item">
                            <strong>${conv.title || 'Conversa sem t√≠tulo'}</strong><br>
                            <small>${new Date(conv.startTime).toLocaleString('pt-BR')}</small>
                        </div>
                    `).join('');
            } else {
                recentConversations.innerHTML = '<div class="conversation-item">Nenhuma conversa encontrada</div>';
            }
        } catch (error) {
            console.error('Erro ao carregar estat√≠sticas:', error);
            recentConversations.innerHTML = '<div class="conversation-item" style="color: var(--error-color);">Erro ao carregar dados</div>';
        } finally {
            refreshStatsBtn.disabled = false;
            refreshStatsBtn.textContent = 'üîÑ Atualizar Estat√≠sticas';
        }
    }

    async function loadCurrentInstruction() {
        loadInstructionBtn.disabled = true;
        loadInstructionBtn.textContent = 'üì• Carregando...';
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/system-instruction`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (response.ok) {
                const data = await response.json();
                systemInstructionTextarea.value = data.instruction || '';
                showStatus(instructionStatus, 'Instru√ß√£o atual carregada com sucesso!');
            } else {
                throw new Error('Falha ao carregar instru√ß√£o');
            }
        } catch (error) {
            console.error('Erro ao carregar instru√ß√£o:', error);
            showStatus(instructionStatus, 'Erro ao carregar instru√ß√£o atual.', true);
        } finally {
            loadInstructionBtn.disabled = false;
            loadInstructionBtn.textContent = 'üì• Carregar Atual';
        }
    }

    async function saveInstruction() {
        const instruction = systemInstructionTextarea.value.trim();
        if (!instruction) {
            showStatus(instructionStatus, 'Por favor, digite uma instru√ß√£o antes de salvar.', true);
            return;
        }

        saveInstructionBtn.disabled = true;
        saveInstructionBtn.textContent = 'üíæ Salvando...';
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/system-instruction`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ instruction })
            });
            if (response.ok) {
                showStatus(instructionStatus, 'Nova instru√ß√£o salva com sucesso! ‚úÖ');
            } else {
                throw new Error('Falha ao salvar instru√ß√£o');
            }
        } catch (error) {
            console.error('Erro ao salvar instru√ß√£o:', error);
            showStatus(instructionStatus, 'Erro ao salvar a instru√ß√£o.', true);
        } finally {
            saveInstructionBtn.disabled = false;
            saveInstructionBtn.textContent = 'üíæ Salvar Nova Instru√ß√£o';
        }
    }

    function handleLogout() {
        authToken = '';
        adminPassword.value = '';
        systemInstructionTextarea.value = '';
        adminPanel.classList.add('hidden');
        loginScreen.classList.remove('hidden');
        loginError.classList.add('hidden');
    }

    // Event Listeners
    loginBtn.addEventListener('click', handleLogin);
    adminPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    logoutBtn.addEventListener('click', handleLogout);
    refreshStatsBtn.addEventListener('click', loadStatistics);
    loadInstructionBtn.addEventListener('click', loadCurrentInstruction);
    saveInstructionBtn.addEventListener('click', saveInstruction);

    adminPassword.focus();
</script>
</body>
</html>
